{% extends "base.html" %}

{% block title %}Rankings - {{ weight_class }} lbs{% endblock %}

{% block content %}
<h1 class="text-center">{{ weight_class }} lbs Rankings - Season: {{ selected_season.name }}</h1> <!-- Display current season -->

<!-- Badges for currently applied filters -->
<div class="mb-3 text-center">
    {% if selected_region %}
        <span class="badge badge-primary">Region: {{ selected_region }}</span>
    {% endif %}
    {% if selected_conference %}
        <span class="badge badge-success">Conference: {{ selected_conference }}</span>
    {% endif %}
    {% if not selected_region and not selected_conference %}
        <span class="badge badge-info">All Regions & Conferences</span>
    {% endif %}
</div>

<!-- Form for selecting region and conference -->
<form method="GET" action="{{ url_for('rankings', weight_class=weight_class) }}" id="rankingsFilterForm" class="form-inline mb-3 justify-content-center">
    <input type="hidden" name="season_id" value="{{ selected_season_id }}"> <!-- Ensure season_id persists -->

    <div class="form-group mr-2">
        <label for="region" class="mr-2">Region</label>
        <select name="region" id="region" class="form-control" onchange="this.form.submit()">
            <option value="" {% if not selected_region %}selected{% endif %}>All Regions</option>
            {% for region_num in regions %}
                <option value="{{ region_num }}" {% if selected_region and selected_region|string == region_num|string %}selected{% endif %}>Region {{ region_num }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group mr-2">
        <label for="conference" class="mr-2">Conference</label>
        <select name="conference" id="conference" class="form-control" onchange="this.form.submit()">
            <option value="" {% if not selected_conference %}selected{% endif %}>All Conferences</option>
            {% for conference_name in conferences %}
                <option value="{{ conference_name }}" {% if selected_conference == conference_name %}selected{% endif %}>{{ conference_name }}</option>
            {% endfor %}
        </select>
    </div>

    {% if clear_filters %}
        <a href="{{ url_for('rankings', weight_class=weight_class) }}?season_id={{ selected_season_id }}" class="btn btn-outline-secondary mt-2 mt-md-0">
            <i class="fas fa-times-circle"></i> Clear Filters
        </a>
    {% endif %}
</form>

<!-- Rankings Table -->
{% if wrestlers %}
    <div class="table-responsive">
        <table class="table table-striped table-light table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Rank</th>
                    <th>Wrestler</th>
                    <th>School</th>
                    <th>Region</th>
                    <th>Conference</th>
                    <th>Wins</th>
                    <th>Losses</th>
                    <th>Win %</th>
                    <th>
                        <a href="?sort_by=elo&season_id={{ selected_season_id }}{% if selected_region %}&region={{ selected_region }}{% endif %}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" class="sort-link">Elo Rating</a>
                    </th>
                    <th>
                        <a href="?sort_by=rpi&season_id={{ selected_season_id }}{% if selected_region %}&region={{ selected_region }}{% endif %}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" class="sort-link">RPI</a>
                    </th>
                    <th>
                        <a href="?sort_by=hybrid&season_id={{ selected_season_id }}{% if selected_region %}&region={{ selected_region }}{% endif %}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" class="sort-link">Hybrid Score</a>
                    </th>
                    <th>
                        <a href="?sort_by=dominance&season_id={{ selected_season_id }}{% if selected_region %}&region={{ selected_region }}{% endif %}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" class="sort-link">Dominance Score</a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for wrestler in wrestlers %}
                    <tr class="{% if loop.index is odd %}table-row-light{% else %}table-row-dark{% endif %}">
                        <td>{{ loop.index }}</td>
                        <td><a href="{{ url_for('wrestler_detail', wrestler_id=wrestler.id) }}?season_id={{ selected_season_id }}">{{ wrestler.name }}</a></td> <!-- Passing season_id -->
                        <td>{{ wrestler.school }}</td>
                        <td>{{ wrestler.region }}</td>
                        <td>{{ wrestler.conference }}</td>
                        <td>{{ wrestler.wins }}</td> <!-- Ensure wins are updated -->
                        <td>{{ wrestler.losses }}</td> <!-- Ensure losses are updated -->
                        <td>{{ "%.1f"|format(wrestler.win_percentage) }}%</td>
                        <td>{{ "%.2f"|format(wrestler.elo_rating) }}</td>
                        <td>{{ "%.3f"|format(wrestler.rpi if wrestler.rpi is not none else 0.000) }}</td>
                        <td>{{ "%.3f"|format(wrestler.hybrid_score if wrestler.hybrid_score is not none else 0) }}</td>
                        <td>{{ "%.2f"|format(wrestler.dominance_score) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p>No wrestlers found for this weight class.</p>
{% endif %}
{% endblock %}

<!-- Add Mobile-Friendly Styles -->
<style>
    /* Ensure table is scrollable on small screens */
    .table-responsive {
        overflow-x: auto;
    }

    /* Center align text for mobile */
    .form-inline label {
        white-space: nowrap;
    }

    /* Adjust font sizes and padding for smaller screens */
    @media (max-width: 767px) {
        h1, h2, h3 {
            font-size: 1.25rem;
        }

        .form-group label {
            font-size: 0.9rem;
        }

        .form-control {
            font-size: 0.9rem;
        }

        .btn, .badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        .table th, .table td {
            padding: 0.5rem;
        }
    }
</style>
